# SAC Charts System Design

## Overview

SAC Charts is implemented as a Lightning Web Component (LWC) named `dynamicCharts`. The component obtains data from CRM Analytics using wire adapters, generates SAQL queries based on user-selected filters, and renders charts with the ApexCharts JavaScript library.
The objective of this system is twofold:

1. Manage the application lifecycle through Change Requests (CRs) which specify changes to the architecture and program flow.
2. Manage the reporting lifecycle through adding, changing and deleting charts through Dashboard Requests (DRs)
   Because the reporting lifecycle is to be kept separate from the application lifecycle, with no audit trail necessary, specific dashboard requrirements are meant to be left out of SDD and SRDs

The project follows the Salesforce DX structure with source located under `force-app/main/default` and uses `sfdx-lwc-jest` for unit testing.
All automation scripts assume a Node.js 18 runtime. Using older or unsupported versions may cause `npm install` failures or other issues with the Salesforce CLI.

## Architecture

```
+-----------------------+
| Salesforce UI (LWC)   |
+-----------+-----------+
            |
            v
+-----------+-----------+
| dynamicCharts.js      |
| - Builds SAQL queries |
| - Uses ApexCharts     |
+-----------+-----------+
            |
            v
+-----------+-----------+
| CRM Analytics (Wave)  |
| Datasets via API      |
+-----------------------+
```

### Key Components

- **dynamicCharts.js**: Core logic for loading datasets, handling filter selections, generating SAQL, cross-filtering available options, and rendering six charts with ApexCharts.
- The component applies visual effects such as drop shadows based on chart settings to enhance chart readability.
- **dynamicCharts.html**: Presents filter controls and a left-hand list of chart names. Each chart pair appears on its own page that can be selected from this list.
- **dynamicCharts.js-meta.xml**: Exposes the component to App, Record, and Home pages.
- **DPOStateMachine.cls**: Placeholder Apex class reserved for future enhancements or server-side processing.
- **charts.json**: Generated from the CRM Analytics dashboards to list supported charts. Primary charts are included, while `AO` variants are ignored.
- **revEngCharts.json**: Generated from the LWC charts to build a comparable reference of the current configuration
- **changeRequests.json**: Output from changeRequestGenerator showing updates needed to sync the LWC with charts.json
- **changeRequestInstructions.txt**: Generated by `scripts/changeRequestInterpreter.js` containing developer steps mapped to ApexCharts option paths
- **syncCharts.js**: Consumes `changeRequests.json` to automatically refactor `dynamicCharts.html` and `dynamicCharts.js`.

## Data Flow

1. `getDatasets` retrieves dataset IDs when the component initializes.
2. Dual list boxes and combo box capture filter selections from the user.
3. A left-hand navigation list allows the user to switch between chart pages.
4. Option queries apply the currently selected filters (excluding the field being queried) so that each filter only displays valid values.
5. Chart queries are placed into a queue and executed via a single `executeQuery` wire adapter using the `nextQuery` getter.
6. The first bar chart uses the filters as selected; the second applies the inverse of the `host` and `nation` filters.
7. The **Render** button triggers `filtersUpdated`, which refreshes every chart with new query data.
8. The queue ensures no more than one CRM Analytics query runs at a time so the five-concurrent limit is never exceeded.

## Dependencies

- **ApexCharts**: Loaded once from the static resource `ApexCharts` on first render and reused for all charts.
- **lightning/analyticsWaveApi**: Provides `getDatasets` and `executeQuery` wire adapters.
- **Salesforce LWC**: Standard library for creating Lightning Web Components.
- **sfdcAuthorizer**: Node script that performs JWT-based authentication so other automation agents can access the org.
 - **dashboardRetriever**: Downloads dashboard state JSON using the CRM Analytics REST API so parsing agents can generate `charts.json`. When a dashboard label is supplied, it first queries the REST API to determine the API name.
- **dashboardReader**: Parses exported dashboard JSON into normalized chart definitions written to `charts.json`.
- **lwcReader**: Creates Lightning Web Component scaffolding from `charts.json` and writes the files under `force-app/main/default/lwc`.
- **changeRequestGenerator**: Compares `charts.json` with `revEngCharts.json` to produce `changeRequests.json` for synchronizing the component source.
- **syncCharts**: Reads `changeRequests.json` and updates the `dynamicCharts` LWC by modifying the HTML and JS files via AST transforms.
- **sfdcDeployer**: Deploys metadata in `force-app/main/default` to the target org using the `sf` CLI and writes a JSON report under `reports/`.
- **Salesforce CLI** and **Jest** are included in `devDependencies` so running `npm install` prepares the full toolchain automatically.

## Testing

Unit tests reside under `force-app/main/default/lwc/dynamicCharts/__tests__` and use `sfdx-lwc-jest`. Additional Apex test classes are stored in the `force-app/test` package to validate server-side code. The root `test` directory contains integration checksâ€”for example, verifying that chart container IDs (and their `AO` counterparts) match the chart definitions in `charts.json`.
The suite also verifies that each chart container creates an ApexCharts instance by mocking `lightning/platformResourceLoader` to load the real library.
Test execution is orchestrated by the `lwcTester` agent which installs required dev dependencies, scaffolds `test/lwcTester`, and runs Jest with coverage thresholds prior to deployment.

## Future Considerations

- Implement additional chart types (line, pie, etc.) using ApexCharts options.
- Integrate server-side logic via the `DPOStateMachine` Apex class for more complex query operations.
- Provide configuration to select datasets and SAQL queries through custom metadata or custom settings.
