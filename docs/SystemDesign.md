# SAC Charts System Design

## Overview

SAC Charts is implemented as a Lightning Web Component (LWC) named `dynamicCharts`. The component obtains data from CRM Analytics using wire adapters, generates SAQL queries based on user-selected filters, and renders charts with the ApexCharts JavaScript library.
The latest dashboard definition consolidates the visualization set to three charts: `ClimbsByNation`, `TimeByPeak`, and `CampsByPeak`. Two bar charts display climb counts and average camps while a box plot shows days per peak. Each chart container name matches its dashboard title.

Chart titles and metadata were updated in change request **CR-02**:

- **Top 20 Climbs by Nation**
- **Days per Peak by Top 20 Climbs**
- **Average Number of Camps per Peak**

Field labels and color schemes were also aligned with CR-02:

- `ClimbsByNation` displays the `Nation` field using color `#002060` with a shadow.
- `TimeByPeak` maps `Peak ID` and quartile fields and uses colors `#97C1DA,#002060`.
- `CampsByPeak` maps `Peak ID` and `Average Camps` and uses color `#175F68`.

Each chart record now includes a `dashboard` attribute set to `CR_02` to track
its originating dashboard. The deprecated **DaysPerPeak** chart has been removed
from the LWC implementation.

The project follows the Salesforce DX structure with source located under `force-app/main/default` and uses `sfdx-lwc-jest` for unit testing.

## Architecture

```
+-----------------------+
| Salesforce UI (LWC)   |
+-----------+-----------+
            |
            v
+-----------+-----------+
| dynamicCharts.js      |
| - Builds SAQL queries |
| - Uses ApexCharts     |
+-----------+-----------+
            |
            v
+-----------+-----------+
| CRM Analytics (Wave)  |
| Datasets via API      |
+-----------------------+
```

### Key Components

- **dynamicCharts.js**: Core logic for loading datasets, handling filter selections, generating SAQL, cross-filtering available options, and rendering five charts with ApexCharts.
- **dynamicCharts.html**: Presents filter controls and five chart containers arranged in multiple cards.
- **dynamicCharts.js-meta.xml**: Exposes the component to App, Record, and Home pages.
- **DPOStateMachine.cls**: Placeholder Apex class reserved for future enhancements or server-side processing.
- **charts.json**: Generated from the CRM Analytics dashboards to list supported charts. Primary charts are included, while `AO` variants are ignored.
- **revEngCharts.json**: Generated from the LWC charts to build a comparable reference of the current configuration
- **changeRequests.json**: Output from changeRequestGenerator showing updates needed to sync the LWC with charts.json
- **changeRequestInstructions.txt**: Generated by `scripts/changeRequestInterpreter.js` containing developer steps

## Data Flow

1. `getDatasets` retrieves dataset IDs when the component initializes.
2. Dual list boxes and combo box capture filter selections from the user.
3. Option queries apply the currently selected filters (excluding the field being queried) so that each filter only displays valid values.
4. `executeQuery` runs SAQL queries for all charts using the selected filters.
5. The first bar chart uses the filters as selected; the second applies the inverse of the `host` and `nation` filters.
6. Updating filters triggers `filtersUpdated`, which refreshes every chart with new query data.

## Dependencies

- **ApexCharts**: Loaded from the static resource `ApexCharts` at runtime.
- **lightning/analyticsWaveApi**: Provides `getDatasets` and `executeQuery` wire adapters.
- **Salesforce LWC**: Standard library for creating Lightning Web Components.

## Testing

Unit tests reside under `force-app/main/default/lwc/dynamicCharts/__tests__` and use `sfdx-lwc-jest`. Additional Apex test classes are stored in the `force-app/test` package to validate server-side code. The sample tests verify that all chart containers render when the component is created.

## Future Considerations

- Implement additional chart types (line, pie, etc.) using ApexCharts options.
- Integrate server-side logic via the `DPOStateMachine` Apex class for more complex query operations.
- Provide configuration to select datasets and SAQL queries through custom metadata or custom settings.
